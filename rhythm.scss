@use "sass:map";
@use "sass:math";
@use "sass:string";

// Default variables
// -----------------
$global-rhythm-size: 8px !default;
$global-baseline-raito: 0 !default;

// Helper functions
// ----------------
@function _unit($value) {
  @return string.slice(#{$value * 0}, 2, -1);
}

@function _calc-baseline-from-bottom($font-size, $line-height-rhythm, $baseline-ratio) {
  @return ($line-height-rhythm * $global-rhythm-size - $font-size) / 2 + $font-size *
    $baseline-ratio;
}

@function _calc-baseline-offset($baseline-from-bottom) {
  @return math.round($baseline-from-bottom % $global-rhythm-size);
}

@function _calc-top-rhythm-size($rhythm-steps, $baseline-offset) {
  @if $baseline-offset == 0 {
    @return rhythm($rhythm-steps);
  }

  @if $rhythm-steps > 0 {
    @return $rhythm-steps * $global-rhythm-size - $baseline-offset;
  }

  @if $rhythm-steps < 0 {
    @return ($rhythm-steps + 1) * $global-rhythm-size - $baseline-offset;
  }

  @return 0;
}

@function _calc-bottom-rhythm-size($rhythm-steps, $baseline-offset) {
  @if $baseline-offset == 0 {
    @return rhythm($rhythm-steps);
  }

  @if $rhythm-steps > 0 {
    @return ($rhythm-steps - 1) * $global-rhythm-size + $baseline-offset;
  }

  @if $rhythm-steps < 0 {
    @return $rhythm-steps * $global-rhythm-size + $baseline-offset;
  }

  @return 0;
}

// Functions
// ----------------
@function rhythm($rhythm-steps) {
  @return $rhythm-steps * $global-rhythm-size;
}

@function top-rhythm-for($font-map, $rhythm-steps) {
  $_baseline-from-bottom: _calc-baseline-from-bottom(
    map.get($font-map, font-size),
    map.get($font-map, line-height-rhythm),
    map.get($font-map, baseline-ratio) or $global-baseline-raito
  );
  $_baseline-offset: _calc-baseline-offset($_baseline-from-bottom);

  @return _calc-top-rhythm-size($rhythm-steps, $_baseline-offset);
}

@function bottom-rhythm-for($font-map, $rhythm-steps) {
  $_baseline-from-bottom: _calc-baseline-from-bottom(
    map.get($font-map, font-size),
    map.get($font-map, line-height-rhythm),
    map.get($font-map, baseline-ratio) or $global-baseline-raito
  );
  $_baseline-offset: _calc-baseline-offset($_baseline-from-bottom);

  @return _calc-bottom-rhythm-size($rhythm-steps, $_baseline-offset);
}
