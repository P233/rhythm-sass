@use "sass:map";
@use "sass:math";
@use "sass:string";

// Global variables
// ----------------
$global-rhythm-size: 8px !default;
$global-baseline-raito: 0 !default;

// Helper functions
// ----------------
@function _unit($value) {
  @return string.slice(#{$value * 0}, 2, -1);
}

@function _calc-baseline-from-bottom($font-map) {
  $_font-size: map.get($font-map, font-size);
  $_line-height-rhythm: map.get($font-map, line-height-rhythm);
  $_baseline-ratio: map.get($font-map, baseline-ratio) or $global-baseline-raito;

  @return math.round(
    ($_line-height-rhythm * $global-rhythm-size - $_font-size) / 2 + $_font-size *
      $_baseline-ratio
  );
}

@function _calc-baseline-from-top($font-map) {
  $_line-height: map.get($font-map, line-height-rhythm) * $global-rhythm-size;

  @return $_line-height - _calc-baseline-from-bottom($font-map);
}

@function _calc-baseline-offset($font-map) {
  $_baseline-from-bottom: _calc-baseline-from-bottom($font-map);

  @return $_baseline-from-bottom % $global-rhythm-size;
}

// Functions
// ----------------
@function rhythm($rhythm-steps, $offset: 0) {
  @return $rhythm-steps * $global-rhythm-size + $offset;
}

@function top-rhythm($font-map, $rhythm-steps, $offset: 0) {
  $_baseline-offset: _calc-baseline-offset($font-map);

  @if $_baseline-offset == 0 {
    @return rhythm($rhythm-steps, $offset);
  } @else if $rhythm-steps > 0 {
    @return ($rhythm-steps - 1) * $global-rhythm-size + $_baseline-offset + $offset;
  } @else if $rhythm-steps < 0 {
    @return -(math.abs($rhythm-steps) * $global-rhythm-size - $_baseline-offset) + $offset;
  } @else {
    @return 0 + $offset;
  }
}

@function bottom-rhythm($font-map, $rhythm-steps, $offset: 0) {
  $_baseline-offset: _calc-baseline-offset($font-map);

  @if $_baseline-offset == 0 {
    @return rhythm($rhythm-steps, $offset);
  } @else if $rhythm-steps > 0 {
    @return $rhythm-steps * $global-rhythm-size - $_baseline-offset + $offset;
  } @else if $rhythm-steps < 0 {
    @return -((math.abs($rhythm-steps) - 1) * $global-rhythm-size + $_baseline-offset) + $offset;
  } @else {
    @return 0 + $offset;
  }
}

@function mid-rhythm($top-font-map, $bottom-font-map, $rhythm-steps, $offset: 0) {
  @if $rhythm-steps < 1 {
    @error "The $rhythm-steps between two elements must larger or equal to 1, but the given value is #{$rhythm-steps}.";
  }

  $_top-font-bottom-rhythm: bottom-rhythm($top-font-map, $rhythm-steps);
  $_bottom-font-baseline-from-top: _calc-baseline-from-top($bottom-font-map);

  @return $_top-font-bottom-rhythm - $_bottom-font-baseline-from-top + $offset;
}
