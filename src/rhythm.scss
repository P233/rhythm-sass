@use "lib";
@use "sass:map";
@use "sass:math";
@use "sass:meta";

// ------------------ //
//  Global Variables  //
// ------------------ //

$baseline-ratio: null !default;
@if not lib.is-valid-baseline-ratio($baseline-ratio) {
  @error "Invalid $baseline-ratio: #{meta.inspect($baseline-ratio)}. The value must be a decimal greater than 0 and less than 1.";
}

$rhythm-size: 8px !default;
@if meta.type-of($rhythm-size) != number or not lib.has-valid-unit($rhythm-size) {
  @error "Invaild $rhythm-size: #{meta.inspect($rhythm-size)}. The value should be a number in an absolute length unit or the REM unit.";
}

$rem-size: 16px !default;
@if meta.type-of($rem-size) != number or not lib.has-valid-unit($rem-size) {
  @error "Invaild $rem-size: #{meta.inspect($rem-size)}. The value should be a number in an absolute length unit or the REM unit.";
}

$__config: (
  baseline-ratio: $baseline-ratio,
  rhythm-size: $rhythm-size,
  rem-size: $rem-size
);

// ------------------ //
//  Rhythm Functions  //
// ------------------ //

@function rhythm($rhythms, $offset: 0) {
  $_rhythms: lib.validate-rhythms($rhythms);
  $_height: $rhythm-size * $_rhythms;
  $_offset: lib.validate-offset($offset);

  @return lib.calc-height-with-offset($_height, $_offset);
}

@function rhythm-top($font-map, $rhythms, $offset: 0) {
  $_font-map: lib.validate-font-map($font-map);
  $_rhythms: lib.validate-rhythms($rhythms);
  $_height: $rhythm-size * $_rhythms - lib.calc-baseline-height($_font-map, "bottom", $__config);
  $_offset: lib.validate-offset($offset);

  @return lib.calc-height-with-offset($_height, $_offset);
}

@function rhythm-bottom($font-map, $rhythms, $offset: 0) {
  $_font-map: lib.validate-font-map($font-map);
  $_rhythms: lib.validate-rhythms($rhythms);
  $_height: $rhythm-size * $_rhythms - lib.calc-baseline-height($_font-map, "top", $__config);
  $_offset: lib.validate-offset($offset);

  @return lib.calc-height-with-offset($_height, $_offset);
}

@function baseline-top($font-map, $rhythms, $offset: 0) {
  @return rhythm-bottom($font-map, $rhythms, $offset);
}

@function baseline-bottom($font-map, $rhythms, $offset: 0) {
  @return rhythm-top($font-map, $rhythms, $offset);
}

@function baseline-between($font-map-above, $font-map-below, $rhythms, $offset: 0) {
  $_font-map-above: lib.validate-font-map($font-map-above);
  $_font-map-below: lib.validate-font-map($font-map-below);
  $_rhythms: lib.validate-rhythms($rhythms);
  $_height: baseline-bottom($_font-map-above, $_rhythms) - lib.calc-baseline-height($_font-map-below, "top", $__config);
  $_offset: lib.validate-offset($offset);

  @return lib.calc-height-with-offset($_height, $_offset);
}

// -------- //
//  Mixins  //
// -------- //

@mixin font($font-map, $spacing-map: ()) {
  $_font-map: lib.validate-font-map($font-map);

  font-size: map.get($_font-map, font-size);
  line-height: $rhythm-size * map.get($_font-map, line-height);

  @each $_property in map.keys(map.remove($_font-map, font-size, line-height, baseline-ratio)) {
    #{$_property}: map.get($_font-map, $_property);
  }

  @each $_property, $_value in $spacing-map {
    $_result: null;

    @if $_property == margin-top or $_property == padding-top {
      @if meta.type-of(lib.first($_value)) == map {
        $_result: baseline-between(lib.first($_value), $_font-map, lib.rest($_value)...);
      } @else {
        $_result: baseline-top($_font-map, $_value...);
      }
    } @else if $_property == margin-bottom or $_property == padding-bottom {
      @if meta.type-of(lib.first($_value)) == map {
        $_result: baseline-between($_font-map, lib.first($_value), lib.rest($_value)...);
      } @else {
        $_result: baseline-bottom($_font-map, $_value...);
      }
    } @else {
      @error "Unsupported property #{meta.inspect($_property)} in #{meta.inspect($spacing-map)}.";
    }

    @if ($_property == padding-top or $_property == padding-bottom) and $_result < 0 {
      @error "The calculated #{$_property} value is #{$_result}, which is negative. Please update your rhythm counts to ensure a positive value.";
    }

    #{$_property}: $_result;
  }
}

@mixin draw-rhythms($color: rgb(255 120 120 / 25%)) {
  :root {
    position: relative;

    &::after {
      content: "";
      position: absolute;
      z-index: 1000000;
      inset: 0;
      pointer-events: none;
      background-image: linear-gradient(to bottom, $color $rhythm-size, transparent $rhythm-size);
      background-size: 100% ($rhythm-size * 2);
    }
  }
}
